# 上下文检索策略分析

## 1. 核心问题定义

为了在保持高准确率的同时优化延迟，核心挑战在于 **上下文效率 (Context Efficiency)**：
> **"如何高效地识别并向 Agent 上下文注入*最少且必要*的设备和 Schema 信息？"**

这可以拆解为两个耦合的子问题：

### 1.1 准确的设备识别 (意图识别)
系统必须将自然语言正确映射到具体的设备实例。
*   **明确指向**: "打开小米台灯"。
*   **模糊指向**: "把灯打开" (范围模糊)。
*   **逻辑指向**: "关闭除卧室以外的所有灯" (集合操作)。
*   **上下文指向**: "把它关掉" (多轮对话引用)。

### 1.2 准确的 Schema 检索
一旦确定了目标设备（或候选设备），系统必须向 LLM 提供其控制规格 (Schema)。
*   **异构性**: 不同品牌/型号的命令结构不同。
*   **冗余性**: 为 50 个相同的灯泡注入完整的 Schema 会浪费 Token 并干扰注意力。

---

## 2. 问题拆解与分析

我们需要从 **规模 (Scale)** 和 **复杂度 (Complexity)** 两个维度来分析解决方案空间。

### 2.1 规模维度 (设备数量)
| 规模 | 特征 | 瓶颈 |
|------|------|------|
| **小型 (<50)** | 轻松放入上下文 | 延迟 (如果使用多阶段架构) |
| **大型 (>200)** | 超出高效上下文范围 | 检索准确率 & 上下文窗口限制 |

### 2.2 语义维度 (用户意图)
| 复杂度 | 示例 | 需求 |
|--------|------|------|
| **L1: 直接** | "客厅灯" | 关键词/向量匹配 |
| **L2: 属性** | "所有灯" | 元数据过滤 (`type=light`) |
| **L3: 逻辑** | "除了卧室因为的所有..." | 负向过滤 / 集合逻辑 |
| **L4: 指代** | "把它调亮" | 历史状态追踪 |

---

## 3. 建议解决方案策略 (待评审)

我们提出一种随复杂度扩展的 **自适应架构 (Adaptive Architecture)**。

### 3.1 自适应检索策略 (Adaptive Retrieval Strategy)
流水线不采用"一刀切"的方式，而是根据 **用户元数据 (设备数量)** 动态调整。

#### 路径 A: 直接注入 (Direct Injection) —— 快速路径
*   **触发条件**: `User.DeviceCount < 阈值` (例如 50)。
*   **逻辑**:
    1.  检索用户的 **所有** 设备。
    2.  将简化的 Schema 注入系统 Prompt。
    3.  **1-RTT 推理**: LLM 同时进行设备识别和命令生成。
*   **优点**: 语义延迟最低，架构最简单，天然支持复杂逻辑。

#### 路径 B: 两阶段过滤 (Two-Stage Filtering) —— 扩展路径
*   **触发条件**: `User.DeviceCount >= 阈值`。
*   **阶段 1: 意图预筛选 (本地/快速)**
    *   **目标**: 将搜索空间从 ~200+ 缩减到 ~20 个候选者。
    *   **方法**:
        *   **解析器**: 提取语义标签 (`#light`, `@living_room`, `#exclude:bedroom`)。
        *   **过滤器**: 使用标签查询元数据数据库。
*   **阶段 2: 上下文注入**
    *   仅注入过滤后的候选设备 Schema。
*   **阶段 3: LLM 推理**
    *   进行最终的消歧和命令生成。

### 3.2 Schema 优化 (基于能力)
为了进一步降低 Token 密度，特别是针对路径 A：
*   **能力解耦 (Decouple Capabilities)**: 全局定义一次 `On/Off`, `Brightness`, `ColorTemp` 的 Schema。
*   **引用实现**: 设备定义仅作为指针。
    *   *优化前*: 50 个灯泡 $\times$ 500 tokens = 25k tokens。
    *   *优化后*: 3 个能力定义 (1k tokens) + 50 个设备引用 (50 $\times$ 20 tokens) = ~2k tokens。

---

## 4. 可行性评审待确认问题 (Open Questions)
1.  **阶段 1 解析器准确性**: 轻量级解析器能否在不依赖 LLM 的情况下可靠地处理 "除了 X 以外的所有" 这种逻辑？
2.  **Schema 指针解析**: LLM 能否在不产生幻觉的情况下，有效地将 "设备 A 使用能力 X" 的关系映射起来？
