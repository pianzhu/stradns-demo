## 上下文

LLM 输出已稳定为命令数组协议（`a/s/n/t/q/c`），但检索链路仍依赖 `ir_compiler` 生成 QueryIR JSON 对象。当前 `command_parser` 通过字符串桥接，导致 `s` 范围语义与多命令拆分存在歧义，且系统提示词分散。

## 目标 / 非目标

- 目标：
  - 统一 LLM 输出协议，以命令数组作为唯一入口。
  - 命令解析直接产出结构化命令对象，严格校验并可降级。
  - 多命令逐条生成 QueryIR 并执行检索，保留语义顺序。
  - `ir_compiler` 不再持有系统提示词。
- 非目标：
  - 不新增额外业务策略（如执行编排、权限校验）。
  - 不引入新的外部依赖或模型供应商。

## 决策

- 采用“LLM → 命令数组 → 解析器 → 多条 QueryIR → 逐条检索”的主路径。
- 保留 `DashScopeLLM.parse_with_prompt` 以支持批量仲裁 prompt，不与命令解析耦合。
- `command_parser` 直接解析对象数组，保留可选 legacy 字符串解析作为降级路径。

## 考虑的替代方案

- 仅取第一条命令：改动小但丢失多命令语义。
- 继续字符串桥接：实现成本低但易引入解析偏差与维护复杂度。

## 风险 / 权衡

- 风险：检索接口返回结构变化影响调用方。
- 缓解：新增多命令结果结构，保留单命令兼容入口（仅在必要场景启用）。

## 迁移计划

- 先完成解析与模型层改造，再调整检索管线与测试。
- 与现有 `improve-command-parser` 变更保持一致，避免协议漂移。

## 待决问题

- 是否需要对外提供“仅取首条命令”的兼容开关作为过渡。
