# 提案：改进指令解析输出协议（多命令 + 槽位升华）

## 为什么

当前指令解析主要停留在“字符串切分”，通常只能稳定输出单条三段式 `ACTION-SCOPE-TARGET`。当用户输入包含多命令、多目标、多动作或指代/量词/数量等语义时，输出缺少可解析、可验证、可扩展的结构，导致消费侧难以可靠执行与降级。

## 变更内容

- 输出协议升级为：**始终输出** `JSON array<object>`；即使只有一条命令也必须用数组包装。
- 每条命令为对象字段：`a/s/n/t/q/c`，最小化承载 `type（闭集）/量词/数量/指代` 等语义信息。
- 消费侧可按需桥接为 `ACTION-SCOPE-TARGET` 以复用旧解析逻辑。
- 明确多命令拆分规则：多动作、多目标、先后顺序必须拆分，并保持原句顺序输出。
- 规定解析失败的统一降级输出：`[{"a":"UNKNOWN","s":"*","n":"*","t":"Unknown","q":"one"}]`。
- **重大变更**：消费侧不再接受“裸字符串”作为 LLM 输出；必须支持 JSON 对象数组（短期可先降级只取第 1 条命令）。

## 非目标

- 不引入更复杂的嵌套对象结构（例如 target 子对象）。
- 不在本变更中定义设备消歧、执行编排、权限校验等业务逻辑（属于消费侧/执行侧职责）。
- 不引入大型同义词表或规则引擎（优先由 LLM 在 system prompt 约束下输出 canonical 结果）。

## 影响

- 受影响规范：新增 `command-parser`（本变更）
- 受影响代码（预期）：新增/调整指令解析与校验模块；类型闭集建议复用 `src/context_retrieval/category_gating.py` 中的 `ALLOWED_CATEGORIES` 避免漂移
- 主要风险：模型输出不合规导致解析失败或误执行；通过“严格校验 + 统一降级 + 可观测日志”缓解
