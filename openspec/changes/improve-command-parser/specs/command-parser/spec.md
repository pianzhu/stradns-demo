# 功能：指令解析（多命令 + 槽位升华）

## 概述

系统必须将用户自然语言解析为一组“原子可执行命令”，并以严格 JSON 输出，便于消费侧做确定性解析、校验与降级。为保持兼容性，每条命令仍采用三段式 `ACTION-SCOPE-TARGET`，并在 `TARGET` 内用最小二级分隔承载语义槽位：`NAME#TYPE#Q[#N]`。

## 设计原则

- **结构最小化**：整体仅引入 `JSON array<string>`，避免嵌套对象
- **兼容三段式**：命令主结构保持 `ACTION-SCOPE-TARGET`
- **可验证**：消费侧可以做强校验（闭集 type、量词、数量）并在失败时统一降级
- **原子化**：一个命令只做一件事（多动作/多目标必须拆分）

## 新增需求

### 需求：输出必须为严格 JSON 数组

系统必须只输出一个 `JSON array<string>`，不得输出任何额外文本；即使只有一条命令也必须输出数组。

#### 场景：单条命令也使用数组

- 给定：用户输入为“打开卧室的顶灯”
- 当：系统执行指令解析
- 则：输出必须为 JSON 数组
- 且：数组长度为 1
- 且：数组元素为字符串

### 需求：命令字符串为三段式

系统输出的每条命令必须满足 `ACTION-SCOPE-TARGET` 三段式结构，且三段之间使用 `-` 分隔。

#### 场景：按三段式输出

- 给定：用户输入为“打开卧室的顶灯”
- 当：系统执行指令解析
- 则：输出应为 `["打开-卧室-顶灯#Light#one"]`

### 需求：ACTION 必须原子化且不包含分隔符

系统输出的 `ACTION` 必须表达单一原子动作，且不得包含字符 `-`。

#### 场景：同一目标多动作必须拆分

- 给定：用户输入为“打开卧室顶灯调到50%”
- 当：系统执行指令解析
- 则：输出应包含两条命令，且顺序与原句一致
- 且：示例形态可为 `["打开-卧室-顶灯#Light#one","设置亮度=50%-卧室-顶灯#Light#one"]`

### 需求：SCOPE 采用最小房间表达

系统必须按以下规则输出 `SCOPE`：
- 未提及房间时输出 `*`
- 多房间使用英文逗号分隔，例如 `客厅,卧室`
- 排除房间使用 `!` 前缀，可多个，例如 `*,!卧室,!书房`

#### 场景：未提及房间输出通配符

- 给定：用户输入为“打开灯”
- 当：系统执行指令解析
- 则：SCOPE 应为 `*`

### 需求：TARGET 必须包含语义槽位

系统必须将 `TARGET` 输出为 `NAME#TYPE#Q[#N]`，至少包含 `NAME#TYPE#Q` 三段。

#### 场景：TARGET 至少包含三段

- 给定：用户输入为“打开卧室的顶灯”
- 当：系统执行指令解析
- 则：TARGET 应满足 `NAME#TYPE#Q` 结构
- 且：示例形态可为 `顶灯#Light#one`

### 需求：NAME 的通配与指代

系统必须按以下规则输出 `NAME`：
- 当用户点名具体设备时输出设备名
- 当用户仅按类型泛指且无具体名称时输出 `*`
- 当用户使用指代（如“它/那个/上一个/刚才的”）时输出 `@last`
- NAME 不得包含 `#` 或 `-`（遇到则替换为空格）

#### 场景：指代输出 @last

- 给定：用户输入为“打开它”
- 当：系统执行指令解析
- 则：输出应为 `["打开-*-@last#Unknown#one"]`

### 需求：TYPE 必须来自闭集

系统必须输出 `TYPE` 且其值必须来自闭集：`AirConditioner, Blind, Charger, Fan, Hub, Light, NetworkAudio, Switch, Television, Washer, SmartPlug, Unknown`；无法判断时必须输出 `Unknown`。

#### 场景：无法判断类型输出 Unknown

- 给定：用户输入为“打开它”
- 当：系统执行指令解析
- 则：TYPE 应为 `Unknown`

### 需求：量词 Q 与数量 N

系统必须输出 `Q` 且其值只能为 `one/all/any/except`。当用户明确数量时，系统必须输出 `N` 为整数；否则不得输出 `N` 段。

#### 场景：泛指类型且未说明量词时默认 all

- 给定：用户输入为“打开客厅的灯”
- 当：系统执行指令解析
- 则：NAME 应为 `*`
- 且：Q 应为 `all`
- 且：示例形态可为 `["打开-客厅-*#Light#all"]`

#### 场景：显式数量输出 any + N

- 给定：用户输入为“打开两盏灯”
- 当：系统执行指令解析
- 则：Q 应为 `any`
- 且：N 应为 `2`

### 需求：多目标必须拆分为多条命令

当同一动作作用于多个目标（列举多个设备名、或以“和/以及/、/逗号”等连接）时，系统必须按目标拆分为多条命令。

#### 场景：列举多个设备名拆分

- 给定：用户输入为“打开卧室顶灯和床头灯”
- 当：系统执行指令解析
- 则：输出应包含两条命令
- 且：两条命令的 ACTION 相同

### 需求：排除语义同时落到 SCOPE 与 Q

当用户表达“除了 X 以外”的排除语义时，系统必须在 `SCOPE` 中使用 `!` 表达排除房间，并在 `Q` 中输出 `except`。

#### 场景：除卧室以外的灯

- 给定：用户输入为“打开除卧室以外的灯”
- 当：系统执行指令解析
- 则：输出应为 `["打开-*,!卧室-*#Light#except"]`

### 需求：解析失败统一降级

当系统无法解析用户输入或输出无法满足协议时，系统必须统一降级输出 `["UNKNOWN-*-*#Unknown#one"]`。

#### 场景：无法解析时返回 UNKNOWN

- 给定：用户输入为“（无法理解的输入）”
- 当：系统执行指令解析
- 则：输出应为 `["UNKNOWN-*-*#Unknown#one"]`

### 需求：消费侧必须进行严格校验并可降级

消费侧实现必须对模型输出进行严格解析与校验：优先按 JSON 数组解析；逐条验证三段式与 `TARGET` 槽位；对不合规项进行丢弃或归一化；当全部无效时统一降级为 `UNKNOWN`。

#### 场景：输出包含额外文本时降级

- 给定：模型输出不是合法 JSON 数组（例如包含解释性文本）
- 当：消费侧解析输出
- 则：消费侧应降级为 `UNKNOWN` 并记录错误原因

## 相关功能

- [context-retrieval](../context-retrieval/spec.md)
- [injection](../injection/spec.md)

