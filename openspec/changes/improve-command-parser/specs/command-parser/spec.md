# 功能：指令解析（多命令 + 槽位升华）

## 概述

系统必须将用户自然语言解析为一组“原子可执行命令”，并以严格 JSON 输出，便于消费侧做确定性解析、校验与降级。输出为对象数组，字段采用 `a/s/n/t/q/c` 承载语义槽位；消费侧可桥接为三段式 `ACTION-SCOPE-TARGET` 以复用旧解析逻辑。

## 设计原则

- **结构最小化**：整体仅引入 `JSON array<object>`，避免嵌套对象
- **兼容三段式**：消费侧可桥接为 `ACTION-SCOPE-TARGET`
- **可验证**：消费侧可以做强校验（闭集 type、量词、数量）并在失败时统一降级
- **原子化**：一个命令只做一件事（多动作/多目标必须拆分）

## 新增需求

### 需求：输出必须为严格 JSON 数组

系统必须只输出一个 `JSON array<object>`，不得输出任何额外文本；即使只有一条命令也必须输出数组。

#### 场景：单条命令也使用数组

- 给定：用户输入为“打开卧室的顶灯”
- 当：系统执行指令解析
- 则：输出必须为 JSON 数组
- 且：数组长度为 1
- 且：数组元素为对象

### 需求：命令对象字段完整

系统输出的每条命令必须包含字段 `a/s/n/t/q`，且字段值为字符串；`c` 仅在明确数量时输出整数。

#### 场景：按字段输出

- 给定：用户输入为“打开卧室的顶灯”
- 当：系统执行指令解析
- 则：输出应为 `[{"a":"打开","s":"卧室","n":"顶灯","t":"Light","q":"one"}]`

### 需求：a 必须原子化且不包含分隔符

系统输出的 `a` 必须表达单一原子动作，且不得包含字符 `-`。

#### 场景：同一目标多动作必须拆分

- 给定：用户输入为“打开卧室顶灯调到50%”
- 当：系统执行指令解析
- 则：输出应包含两条命令，且顺序与原句一致
- 且：示例形态可为 `[{"a":"打开","s":"卧室","n":"顶灯","t":"Light","q":"one"},{"a":"设置亮度=50%","s":"卧室","n":"顶灯","t":"Light","q":"one"}]`

### 需求：s 采用最小房间表达

系统必须按以下规则输出 `s`：
- 未提及房间时输出 `*`
- 多房间使用英文逗号分隔，例如 `客厅,卧室`
- 排除房间使用 `!` 前缀，可多个，例如 `*,!卧室,!书房`

#### 场景：未提及房间输出通配符

- 给定：用户输入为“打开灯”
- 当：系统执行指令解析
- 则：s 应为 `*`

### 需求：n/t/q 必须完整

系统必须输出 `n/t/q` 字段，`c` 仅在明确数量时输出。

#### 场景：n/t/q 必须存在

- 给定：用户输入为“打开卧室的顶灯”
- 当：系统执行指令解析
- 则：n/t/q 均应存在
- 且：示例形态可为 `{"n":"顶灯","t":"Light","q":"one"}`

### 需求：n 的通配与指代

系统必须按以下规则输出 `n`：
- 当用户点名具体设备时输出设备名
- 当用户仅按类型泛指且无具体名称时输出该类型的中文名（不要输出 `*`），并与 `t` 一致：
  - Light → 灯
  - AirConditioner → 空调
  - Blind → 窗帘
  - Fan → 风扇
  - Switch → 开关
  - SmartPlug → 插座
  - Television → 电视
  - NetworkAudio → 音响
  - Washer → 洗衣机
  - Charger → 充电器
  - Hub → 网关
- 当用户使用指代（如“它/那个/上一个/刚才的”）时输出 `@last`
- n 不得包含 `#` 或 `-`（遇到则替换为空格）

#### 场景：指代输出 @last

- 给定：用户输入为“打开它”
- 当：系统执行指令解析
- 则：输出应为 `[{"a":"打开","s":"*","n":"@last","t":"Unknown","q":"one"}]`

### 需求：t 必须来自闭集

系统必须输出 `t` 且其值必须来自闭集：`AirConditioner, Blind, Charger, Fan, Hub, Light, NetworkAudio, Switch, Television, Washer, SmartPlug, Unknown`；无法判断时必须输出 `Unknown`。

#### 场景：无法判断类型输出 Unknown

- 给定：用户输入为“打开它”
- 当：系统执行指令解析
- 则：t 应为 `Unknown`

### 需求：量词 q 与数量 c

系统必须输出 `q` 且其值只能为 `one/all/any/except`。当用户明确数量时，系统必须输出 `c` 为整数；否则不得输出 `c` 字段。

#### 场景：泛指类型且未说明量词时默认 all

- 给定：用户输入为“打开客厅的灯”
- 当：系统执行指令解析
- 则：n 应为 `灯`
- 且：q 应为 `all`
- 且：示例形态可为 `[{"a":"打开","s":"客厅","n":"灯","t":"Light","q":"all"}]`

#### 场景：显式数量输出 any + c

- 给定：用户输入为“打开两盏灯”
- 当：系统执行指令解析
- 则：q 应为 `any`
- 且：c 应为 `2`

### 需求：多目标必须拆分为多条命令

当同一动作作用于多个目标（列举多个设备名、或以“和/以及/、/逗号”等连接）时，系统必须按目标拆分为多条命令。

#### 场景：列举多个设备名拆分

- 给定：用户输入为“打开卧室顶灯和床头灯”
- 当：系统执行指令解析
- 则：输出应包含两条命令
- 且：两条命令的 a 相同

### 需求：排除语义同时落到 s 与 q

当用户表达“除了 X 以外”的排除语义时，系统必须在 `s` 中使用 `!` 表达排除房间，并在 `q` 中输出 `except`。

#### 场景：除卧室以外的灯

- 给定：用户输入为“打开除卧室以外的灯”
- 当：系统执行指令解析
- 则：输出应为 `[{"a":"打开","s":"*,!卧室","n":"灯","t":"Light","q":"except"}]`

### 需求：解析失败统一降级

当系统无法解析用户输入或输出无法满足协议时，系统必须统一降级输出 `[{"a":"UNKNOWN","s":"*","n":"*","t":"Unknown","q":"one"}]`。

#### 场景：无法解析时返回 UNKNOWN

- 给定：用户输入为“（无法理解的输入）”
- 当：系统执行指令解析
- 则：输出应为 `[{"a":"UNKNOWN","s":"*","n":"*","t":"Unknown","q":"one"}]`

### 需求：消费侧必须进行严格校验并可降级

消费侧实现必须对模型输出进行严格解析与校验：优先按 JSON 数组解析；逐条验证对象字段；必要时桥接为三段式；对不合规项进行丢弃或归一化；当全部无效时统一降级为 `UNKNOWN`。

#### 场景：输出包含额外文本时降级

- 给定：模型输出不是合法 JSON 数组（例如包含解释性文本）
- 当：消费侧解析输出
- 则：消费侧应降级为 `UNKNOWN` 并记录错误原因

## 相关功能

- [context-retrieval](../context-retrieval/spec.md)
- [injection](../injection/spec.md)
